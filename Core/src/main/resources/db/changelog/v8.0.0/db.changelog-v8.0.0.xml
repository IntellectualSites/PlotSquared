<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="create-cluster-table" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}cluster" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}cluster">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cluster"/>
            </column>
            <column name="pos1_x" type="INT"/>
            <column name="pos1_z" type="INT"/>
            <column name="pos2_x" type="INT"/>
            <column name="pos2_z" type="INT"/>
            <column name="owner" type="VARCHAR(40)"/>
            <column name="world" type="VARCHAR(45)"/>
            <column name="timestamp" type="DATETIME"/>
        </createTable>
    </changeSet>

    <changeSet id="create-cluster-helpers" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}cluster_helpers" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}cluster_helpers">
            <column name="cluster_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cluster_helpers"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cluster_helpers"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-cluster-invite" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}cluster_invited" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}cluster_invited">
            <column name="cluster_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cluster_invited"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cluster_invited"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-cluster-settings" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}cluster_settings" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}cluster_settings">
            <column name="cluster_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cluster_settings"/>
            </column>
            <column name="biome" type="VARCHAR(45)"/>
            <column name="rain" type="INT"/>
            <column name="custom_time" type="BOOLEAN"/>
            <column name="time" type="INT"/>
            <column name="deny_entry" type="BOOLEAN"/>
            <column name="alias" type="VARCHAR(50)"/>
            <column name="merged" type="INT"/>
            <column name="position" type="VARCHAR(50)"/>
        </createTable>
    </changeSet>
    <changeSet id="create-player-meta" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}player_meta" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}player_meta">
            <column autoIncrement="true" name="meta_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_player_meta"/>
            </column>
            <column name="uuid" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="key" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="BLOB">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-plot" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot"/>
            </column>
            <column name="plot_id_x" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="plot_id_z" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="owner" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="world" type="VARCHAR(45)">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="DATETIME"/>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-comments" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_comments" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_comments">
            <column name="world" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_comments"/>
            </column>
            <column name="hashcode" type="INT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_comments"/>
            </column>
            <column name="inbox" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_comments"/>
            </column>
            <column name="comment" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="sender" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-denied" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_denied" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_denied">
            <column name="plot_plot_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_denied"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_denied"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-flags" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_flags" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_flags">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_flags"/>
            </column>
            <column name="plot_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="flag" type="VARCHAR(64)"/>
            <column name="value" type="VARCHAR(512)"/>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-helpers" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_helpers" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_helpers">
            <column name="plot_plot_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_helpers"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_helpers"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-rating" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_rating" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_rating">
            <column name="plot_plot_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_rating"/>
            </column>
            <column name="player" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_rating"/>
            </column>
            <column name="rating" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-settings" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_settings" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_settings">
            <column name="plot_plot_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_settings"/>
            </column>
            <column name="biome" type="VARCHAR(45)"/>
            <column name="rain" type="INT"/>
            <column name="custom_time" type="BOOLEAN"/>
            <column name="time" type="INT"/>
            <column name="deny_entry" type="BOOLEAN"/>
            <column name="alias" type="VARCHAR(50)"/>
            <column name="merged" type="INT"/>
            <column name="position" type="VARCHAR(50)"/>
        </createTable>
    </changeSet>

    <changeSet id="create-plot-trusted" author="plotsquared">
        <preConditions>
            <not>
                <tableExists tableName="${prefix}plot_trusted" />
            </not>
        </preConditions>
        <createTable tableName="${prefix}plot_trusted">
            <column name="plot_plot_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_trusted"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plot_trusted"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add-plot-id-and-flag-constraint" author="plotsquared">
        <addUniqueConstraint columnNames="plot_id, flag" constraintName="uc_4f1a2baba6bdd8ca77f83eb71" tableName="${prefix}plot_flags"/>
    </changeSet>

    <changeSet id="fk-cluster-settings-on-cluster" author="plotsquared">
        <addForeignKeyConstraint baseColumnNames="cluster_id" baseTableName="${prefix}cluster_settings"
                                 constraintName="FK_CLUSTER_SETTINGS_ON_CLUSTER" referencedColumnNames="id"
                                 referencedTableName="${prefix}cluster"/>
    </changeSet>

    <changeSet id="fk-plot-flags-on-plot" author="plotsquared">
        <addForeignKeyConstraint baseColumnNames="plot_id" baseTableName="${prefix}plot_flags" constraintName="FK_PLOT_FLAGS_ON_PLOT"
                                 referencedColumnNames="id" referencedTableName="${prefix}plot"/>
    </changeSet>

    <changeSet id="fk-plot-settings-on-plot-plot" author="plotsquared">
        <addForeignKeyConstraint baseColumnNames="plot_plot_id" baseTableName="${prefix}plot_settings"
                                 constraintName="FK_PLOT_SETTINGS_ON_PLOT_PLOT" referencedColumnNames="id"
                                 referencedTableName="${prefix}plot"/>
    </changeSet>

</databaseChangeLog>
