<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- v7 to v8 Migration for SQLite: Recreate plot table with ID column -->
    <changeSet id="v7-to-v8-sqlite-recreate-plot-table" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}plot"/>
                <not>
                    <columnExists tableName="${prefix}plot" columnName="id"/>
                </not>
            </and>
        </preConditions>
        <comment>Recreate plot table with ID column for SQLite v7 to v8 migration</comment>

        <!-- Create new plot table with ID -->
        <createTable tableName="${prefix}plot_new">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="plot_id_x" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="plot_id_z" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="world" type="VARCHAR(45)">
                <constraints nullable="false"/>
            </column>
            <column name="owner" type="VARCHAR(45)">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Copy data from old table to new table -->
        <sql>
            INSERT INTO ${prefix}plot_new (plot_id_x, plot_id_z, world, owner, timestamp)
            SELECT plot_id_x, plot_id_z, world, owner, timestamp FROM ${prefix}plot
        </sql>

        <!-- Drop old table -->
        <dropTable tableName="${prefix}plot"/>

        <!-- Rename new table to original name -->
        <sql>ALTER TABLE ${prefix}plot_new RENAME TO ${prefix}plot</sql>

        <!-- Add unique constraint on coordinates -->
        <addUniqueConstraint tableName="${prefix}plot"
                           columnNames="world,plot_id_x,plot_id_z"
                           constraintName="uk_plot_coordinates"/>
    </changeSet>

    <!-- v7 to v8 Migration for SQLite: Create plot_settings if it doesn't exist -->
    <changeSet id="v7-to-v8-sqlite-create-plot-settings" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <not>
                    <tableExists tableName="${prefix}plot_settings"/>
                </not>
            </and>
        </preConditions>
        <comment>Create plot_settings table for SQLite v8</comment>

        <createTable tableName="${prefix}plot_settings">
            <column name="plot_plot_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="biome" type="VARCHAR(45)" defaultValue="FOREST">
                <constraints nullable="true"/>
            </column>
            <column name="rain" type="INT" defaultValue="0">
                <constraints nullable="true"/>
            </column>
            <column name="custom_time" type="TINYINT" defaultValue="0">
                <constraints nullable="true"/>
            </column>
            <column name="time" type="INT" defaultValue="8000">
                <constraints nullable="true"/>
            </column>
            <column name="deny_entry" type="TINYINT" defaultValue="0">
                <constraints nullable="true"/>
            </column>
            <column name="alias" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="merged" type="INT">
                <constraints nullable="true"/>
            </column>
            <column name="position" type="VARCHAR(50)" defaultValue="DEFAULT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="${prefix}plot_settings"
                               baseColumnNames="plot_plot_id"
                               referencedTableName="${prefix}plot"
                               referencedColumnNames="id"
                               constraintName="fk_plot_settings_plot"
                               onDelete="CASCADE"/>
    </changeSet>

    <!-- v7 to v8 Migration for SQLite: Update plot membership tables -->
    <changeSet id="v7-to-v8-sqlite-update-plot-trusted" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}plot_trusted"/>
                <columnExists tableName="${prefix}plot" columnName="id"/>
            </and>
        </preConditions>
        <comment>Update plot_trusted to use new plot IDs for SQLite</comment>

        <!-- SQLite doesn't support ALTER COLUMN, so we recreate the table -->
        <createTable tableName="${prefix}plot_trusted_new">
            <column name="plot_plot_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Copy data with JOIN to get new IDs -->
        <sql>
            INSERT INTO ${prefix}plot_trusted_new (plot_plot_id, user_uuid)
            SELECT p.id, pt.user_uuid
            FROM ${prefix}plot_trusted pt
            JOIN ${prefix}plot p ON pt.plot_id_x = p.plot_id_x AND pt.plot_id_z = p.plot_id_z AND pt.world = p.world
        </sql>

        <dropTable tableName="${prefix}plot_trusted"/>
        <sql>ALTER TABLE ${prefix}plot_trusted_new RENAME TO ${prefix}plot_trusted</sql>

        <addForeignKeyConstraint baseTableName="${prefix}plot_trusted"
                               baseColumnNames="plot_plot_id"
                               referencedTableName="${prefix}plot"
                               referencedColumnNames="id"
                               constraintName="fk_plot_trusted_plot"
                               onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="v7-to-v8-sqlite-update-plot-helpers" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}plot_helpers"/>
                <columnExists tableName="${prefix}plot" columnName="id"/>
            </and>
        </preConditions>
        <comment>Update plot_helpers to use new plot IDs for SQLite</comment>

        <createTable tableName="${prefix}plot_helpers_new">
            <column name="plot_plot_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            INSERT INTO ${prefix}plot_helpers_new (plot_plot_id, user_uuid)
            SELECT p.id, ph.user_uuid
            FROM ${prefix}plot_helpers ph
            JOIN ${prefix}plot p ON ph.plot_id_x = p.plot_id_x AND ph.plot_id_z = p.plot_id_z AND ph.world = p.world
        </sql>

        <dropTable tableName="${prefix}plot_helpers"/>
        <sql>ALTER TABLE ${prefix}plot_helpers_new RENAME TO ${prefix}plot_helpers</sql>

        <addForeignKeyConstraint baseTableName="${prefix}plot_helpers"
                               baseColumnNames="plot_plot_id"
                               referencedTableName="${prefix}plot"
                               referencedColumnNames="id"
                               constraintName="fk_plot_helpers_plot"
                               onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="v7-to-v8-sqlite-update-plot-denied" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}plot_denied"/>
                <columnExists tableName="${prefix}plot" columnName="id"/>
            </and>
        </preConditions>
        <comment>Update plot_denied to use new plot IDs for SQLite</comment>

        <createTable tableName="${prefix}plot_denied_new">
            <column name="plot_plot_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            INSERT INTO ${prefix}plot_denied_new (plot_plot_id, user_uuid)
            SELECT p.id, pd.user_uuid
            FROM ${prefix}plot_denied pd
            JOIN ${prefix}plot p ON pd.plot_id_x = p.plot_id_x AND pd.plot_id_z = p.plot_id_z AND pd.world = p.world
        </sql>

        <dropTable tableName="${prefix}plot_denied"/>
        <sql>ALTER TABLE ${prefix}plot_denied_new RENAME TO ${prefix}plot_denied</sql>

        <addForeignKeyConstraint baseTableName="${prefix}plot_denied"
                               baseColumnNames="plot_plot_id"
                               referencedTableName="${prefix}plot"
                               referencedColumnNames="id"
                               constraintName="fk_plot_denied_plot"
                               onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="v7-to-v8-sqlite-update-plot-rating" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}plot_rating"/>
                <columnExists tableName="${prefix}plot" columnName="id"/>
            </and>
        </preConditions>
        <comment>Update plot_rating to use new plot IDs for SQLite</comment>

        <createTable tableName="${prefix}plot_rating_new">
            <column name="plot_plot_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="player" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            INSERT INTO ${prefix}plot_rating_new (plot_plot_id, rating, player)
            SELECT p.id, pr.rating, pr.player
            FROM ${prefix}plot_rating pr
            JOIN ${prefix}plot p ON pr.plot_id_x = p.plot_id_x AND pr.plot_id_z = p.plot_id_z AND pr.world = p.world
        </sql>

        <dropTable tableName="${prefix}plot_rating"/>
        <sql>ALTER TABLE ${prefix}plot_rating_new RENAME TO ${prefix}plot_rating</sql>

        <addForeignKeyConstraint baseTableName="${prefix}plot_rating"
                               baseColumnNames="plot_plot_id"
                               referencedTableName="${prefix}plot"
                               referencedColumnNames="id"
                               constraintName="fk_plot_rating_plot"
                               onDelete="CASCADE"/>

        <addUniqueConstraint tableName="${prefix}plot_rating"
                           columnNames="plot_plot_id,player"
                           constraintName="uk_plot_rating"/>
    </changeSet>

    <!-- v7 to v8 Migration for SQLite: Recreate cluster table with ID column -->
    <changeSet id="v7-to-v8-sqlite-recreate-cluster-table" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}cluster"/>
                <not>
                    <columnExists tableName="${prefix}cluster" columnName="id"/>
                </not>
            </and>
        </preConditions>
        <comment>Recreate cluster table with ID column for SQLite v7 to v8 migration</comment>

        <createTable tableName="${prefix}cluster_new">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="pos1_x" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="pos1_z" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="pos2_x" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="pos2_z" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="owner" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="world" type="VARCHAR(45)">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            INSERT INTO ${prefix}cluster_new (pos1_x, pos1_z, pos2_x, pos2_z, owner, world, timestamp)
            SELECT pos1_x, pos1_z, pos2_x, pos2_z, owner, world, timestamp FROM ${prefix}cluster
        </sql>

        <dropTable tableName="${prefix}cluster"/>
        <sql>ALTER TABLE ${prefix}cluster_new RENAME TO ${prefix}cluster</sql>
    </changeSet>

    <!-- v7 to v8 Migration for SQLite: Update cluster membership tables -->
    <changeSet id="v7-to-v8-sqlite-update-cluster-helpers" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}cluster_helpers"/>
                <columnExists tableName="${prefix}cluster" columnName="id"/>
            </and>
        </preConditions>
        <comment>Update cluster_helpers to use new cluster IDs for SQLite</comment>

        <createTable tableName="${prefix}cluster_helpers_new">
            <column name="cluster_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_uuid" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            INSERT INTO ${prefix}cluster_helpers_new (cluster_id, user_uuid)
            SELECT c.id, ch.user_uuid
            FROM ${prefix}cluster_helpers ch
            JOIN ${prefix}cluster c ON ch.cluster_id = c.id
        </sql>

        <dropTable tableName="${prefix}cluster_helpers"/>
        <sql>ALTER TABLE ${prefix}cluster_helpers_new RENAME TO ${prefix}cluster_helpers</sql>

        <addForeignKeyConstraint baseTableName="${prefix}cluster_helpers"
                               baseColumnNames="cluster_id"
                               referencedTableName="${prefix}cluster"
                               referencedColumnNames="id"
                               constraintName="fk_cluster_helpers_cluster"
                               onDelete="CASCADE"/>
    </changeSet>

    <!-- Add meta_id to player_meta if missing (SQLite) -->
    <changeSet id="v7-to-v8-sqlite-add-player-meta-id" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <tableExists tableName="${prefix}player_meta"/>
                <not>
                    <columnExists tableName="${prefix}player_meta" columnName="meta_id"/>
                </not>
            </and>
        </preConditions>
        <comment>Add auto-increment meta_id column to existing v7 player_meta table (SQLite)</comment>

        <createTable tableName="${prefix}player_meta_new">
            <column name="meta_id" type="INTEGER" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="uuid" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="key" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="BLOB">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            INSERT INTO ${prefix}player_meta_new (uuid, key, value)
            SELECT uuid, key, value FROM ${prefix}player_meta
        </sql>

        <dropTable tableName="${prefix}player_meta"/>
        <sql>ALTER TABLE ${prefix}player_meta_new RENAME TO ${prefix}player_meta</sql>

        <addUniqueConstraint tableName="${prefix}player_meta"
                           columnNames="uuid,key"
                           constraintName="uk_player_meta"/>
    </changeSet>

    <!-- Create missing tables for v8 if they don't exist (SQLite) -->
    <changeSet id="v7-to-v8-sqlite-create-plot-flags" author="plotsquared" dbms="sqlite">
        <preConditions onFail="MARK_RAN">
            <and>
                <dbms type="sqlite"/>
                <not>
                    <tableExists tableName="${prefix}plot_flags"/>
                </not>
            </and>
        </preConditions>
        <comment>Create plot_flags table if missing (SQLite)</comment>

        <createTable tableName="${prefix}plot_flags">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="plot_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="flag" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="${prefix}plot_flags"
                               baseColumnNames="plot_id"
                               referencedTableName="${prefix}plot"
                               referencedColumnNames="id"
                               constraintName="fk_plot_flags_plot"
                               onDelete="CASCADE"/>

        <createIndex tableName="${prefix}plot_flags" indexName="idx_plot_flags_plot_id">
            <column name="plot_id"/>
        </createIndex>

        <addUniqueConstraint tableName="${prefix}plot_flags"
                           columnNames="plot_id,flag"
                           constraintName="uk_plot_flag"/>
    </changeSet>

</databaseChangeLog>
